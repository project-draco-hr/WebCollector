{
  activeThreads.incrementAndGet();
  FetchItem item=null;
  try {
    while (running) {
      try {
        item=fetchQueue.getFetchItem();
        if (item == null) {
          if (feeder.isAlive() || fetchQueue.getSize() > 0) {
            spinWaiting.incrementAndGet();
            try {
              Thread.sleep(500);
            }
 catch (            Exception ex) {
            }
            spinWaiting.decrementAndGet();
            continue;
          }
 else {
            return;
          }
        }
        lastRequestStart.set(System.currentTimeMillis());
        CrawlDatum crawlDatum=item.datum;
        String url=crawlDatum.getUrl();
        Page page=getPage(crawlDatum);
        crawlDatum.incrRetry(page.getRetry());
        crawlDatum.setFetchTime(System.currentTimeMillis());
        CrawlDatums next=new CrawlDatums();
        if (visit(crawlDatum,page,next)) {
          try {
            dbManager.wrtieFetchSegment(crawlDatum);
            if (page.getResponse() == null) {
              continue;
            }
            if (page.getResponse().isRedirect()) {
              if (page.getResponse().getRealUrl() != null) {
                dbManager.writeRedirectSegment(crawlDatum,page.getResponse().getRealUrl().toString());
              }
            }
            if (!next.isEmpty()) {
              dbManager.wrtieParseSegment(next);
            }
          }
 catch (          Exception ex) {
            LOG.info("Exception when updating db",ex);
          }
        }
        if (visitInterval > 0) {
          try {
            Thread.sleep(visitInterval);
          }
 catch (          Exception sleepEx) {
          }
        }
      }
 catch (      Exception ex) {
        LOG.info("Exception",ex);
      }
    }
  }
 catch (  Exception ex) {
    LOG.info("Exception",ex);
  }
 finally {
    activeThreads.decrementAndGet();
  }
}
