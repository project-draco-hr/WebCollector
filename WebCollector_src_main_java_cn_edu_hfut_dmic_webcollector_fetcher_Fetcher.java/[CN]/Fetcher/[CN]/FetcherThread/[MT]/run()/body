{
  activeThreads.incrementAndGet();
  FetchItem item=null;
  try {
    while (true) {
      try {
        item=fetchQueue.getFetchItem();
        if (item == null) {
          if (feeder.isAlive() || fetchQueue.getSize() > 0) {
            spinWaiting.incrementAndGet();
            try {
              Thread.sleep(500);
            }
 catch (            Exception ex) {
            }
            spinWaiting.decrementAndGet();
            continue;
          }
 else {
            return;
          }
        }
        lastRequestStart.set(System.currentTimeMillis());
        String url=item.datum.getUrl();
        HttpResponse response=null;
        int retryCount=0;
        for (; retryCount <= retry; retryCount++) {
          if (retryCount > 0) {
            LOG.info("retry " + retryCount + "th "+ url);
          }
          try {
            response=httpRequester.getResponse(url);
            break;
          }
 catch (          Exception ex) {
          }
        }
        CrawlDatum crawlDatum=null;
        if (response != null) {
          LOG.info("fetch " + url);
          crawlDatum=new CrawlDatum(url,CrawlDatum.STATUS_DB_FETCHED,item.datum.getRetry() + retryCount);
        }
 else {
          LOG.info("failed " + url);
          crawlDatum=new CrawlDatum(url,CrawlDatum.STATUS_DB_UNFETCHED,item.datum.getRetry() + retryCount);
        }
        try {
          dbUpdater.getSegmentWriter().wrtieFetch(crawlDatum);
          if (response == null) {
            continue;
          }
          String contentType=response.getContentType();
          Visitor visitor=visitorFactory.createVisitor(url,contentType);
          Page page=new Page();
          page.setUrl(url);
          page.setResponse(response);
          if (visitor != null) {
            Links nextLinks=null;
            try {
              nextLinks=visitor.visitAndGetNextLinks(page);
            }
 catch (            Exception ex) {
              LOG.info("Exception",ex);
            }
            if (nextLinks != null && !nextLinks.isEmpty()) {
              dbUpdater.getSegmentWriter().wrtieLinks(nextLinks);
            }
          }
        }
 catch (        Exception ex) {
          LOG.info("Exception",ex);
        }
      }
 catch (      Exception ex) {
        LOG.info("Exception",ex);
      }
    }
  }
 catch (  Exception ex) {
    LOG.info("Exception",ex);
  }
 finally {
    activeThreads.decrementAndGet();
  }
}
