{
  activeThreads.incrementAndGet();
  FetchItem item=null;
  try {
    while (running) {
      try {
        item=fetchQueue.getFetchItem();
        if (item == null) {
          if (feeder.isAlive() || fetchQueue.getSize() > 0) {
            spinWaiting.incrementAndGet();
            try {
              Thread.sleep(500);
            }
 catch (            Exception ex) {
            }
            spinWaiting.decrementAndGet();
            continue;
          }
 else {
            return;
          }
        }
        lastRequestStart.set(System.currentTimeMillis());
        String url=item.datum.getUrl();
        HttpResponse response=null;
        int retryCount=0;
        for (; retryCount <= retry; retryCount++) {
          if (retryCount > 0) {
            LOG.info("retry " + retryCount + "th "+ url);
          }
          try {
            response=httpRequester.getResponse(url);
            break;
          }
 catch (          Exception ex) {
            String logMessage="fetch of " + url + " failed once with "+ ex.getMessage();
            if (retryCount < retry) {
              logMessage+="   retry";
            }
            LOG.info(logMessage);
          }
        }
        CrawlDatum crawlDatum=null;
        if (response != null) {
          LOG.info("fetch " + url);
          crawlDatum=new CrawlDatum(url,CrawlDatum.STATUS_DB_FETCHED,item.datum.getRetry() + retryCount);
        }
 else {
          LOG.info("failed " + url);
          crawlDatum=new CrawlDatum(url,CrawlDatum.STATUS_DB_UNFETCHED,item.datum.getRetry() + retryCount);
        }
        try {
          long fetchStart=System.currentTimeMillis();
          dbUpdater.getSegmentWriter().wrtieFetch(crawlDatum);
          long fetchEnd=System.currentTimeMillis();
          LOG.debug("writing fetch elapse " + (fetchEnd - fetchStart));
          if (response == null) {
            continue;
          }
          if (response.getRedirect()) {
            if (response.getRealUrl() != null) {
              dbUpdater.getSegmentWriter().writeRedirect(response.getUrl(),response.getRealUrl());
            }
          }
          String contentType=response.getContentType();
          Visitor visitor=visitorFactory.createVisitor(url,contentType);
          Page page=new Page();
          page.setUrl(url);
          page.setResponse(response);
          if (visitor != null) {
            Links nextLinks=null;
            try {
              nextLinks=visitor.visitAndGetNextLinks(page);
            }
 catch (            Exception ex) {
              LOG.info("Exception",ex);
            }
            if (nextLinks != null && !nextLinks.isEmpty()) {
              long linkStart=System.currentTimeMillis();
              dbUpdater.getSegmentWriter().wrtieLinks(nextLinks);
              long linkEnd=System.currentTimeMillis();
              LOG.debug("writing link elapse " + (linkEnd - linkStart));
            }
          }
        }
 catch (        Exception ex) {
          LOG.info("Exception",ex);
        }
      }
 catch (      Exception ex) {
        LOG.info("Exception",ex);
      }
    }
  }
 catch (  Exception ex) {
    LOG.info("Exception",ex);
  }
 finally {
    activeThreads.decrementAndGet();
  }
}
